module test_deriv
  use funit
  implicit none

  @testParameter
  type, extends(AbstractTestParameter) :: pencilSize
     integer :: nx, ny, nz
   contains
     procedure :: toString
   end type pencilSize

   @testCase(testParameters={getParameters()}, constructor=newTestDeriv)
   type, extends(ParameterizedTestCase) :: testDeriv
      type(pencilSize) :: pencil_size
    contains
      procedure :: allocate_on_pencil
   end type testDeriv

 contains

   function newTestDeriv(param)
     type(testDeriv) :: newTestDeriv
     type(pencilSize), intent(in) :: param
     newTestDeriv%pencil_size = param
   end function newTestDeriv

   function getParameters() result(test_pencil_sizes)
     type(pencilSize), allocatable :: test_pencil_sizes(:)
     test_pencil_sizes = [ &
          & pencilSize(16,16,16), &
          & pencilSize(32,32,32), &
          & pencilSize(64,64,64) &
          & ]
   end function getParameters

   subroutine allocate_on_pencil(this, array)
     class(testDeriv), intent(in) :: this
     real, allocatable, intent(inout) :: array(:, :, :)
     allocate(array( &
          & this % pencil_size % nx, &
          & this % pencil_size % ny, &
          & this % pencil_size % nz) &
          & )
   end subroutine allocate_on_pencil

   function toString(this) result(string)
     class(pencilSize), intent(in) :: this
     character(:), allocatable :: string
     character(len=80) :: buffer
     write(buffer, '("nx = ",i3.3,1x,"ny = ( ",i3.3,1x,"nz = ( ",i3.3)')
     string = trim(buffer)
   end function toString

  @test
  subroutine test_derx_odd_11(this)
    use x3d_precision, only: pi
    class (testDeriv), intent(inout) :: this
    real, allocatable, dimension(:, :, :) :: func, dfunc, expected_dfunc
    integer :: i, j, k
    real :: x, dx

    call this % allocate_on_pencil(func)
    call this % allocate_on_pencil(dfunc)
    call this % allocate_on_pencil(expected_dfunc)

    dx = 1. / (this % pencil_size % nx - 1)
    do k=1,this % pencil_size % nz
       do j=1,this % pencil_size % ny
          do i=1,this % pencil_size % nx
             x = (i - 1.) * dx * 4. * pi
             func(i,j,k) = sin(x)  !odd
             expected_dfunc(i,j,k) = 4. * pi * cos(x)
          enddo
       enddo
    enddo
    
    write(*, *) this % pencil_size % toString()

    @assertTrue(1 > 0)

    deallocate(func, dfunc, expected_dfunc)

  end subroutine test_derx_odd_11

end module test_deriv

